<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A roofline analysis of matrix-vector multiplication #  The goal of this exercise is to perform a roofline analysis of matrix-vector multiplication. We will look at the effect that compiler flags have on the performance of generated code. Next, we will see if the performance that we obtain is independent of the problem size. Finally, we will investigate loop blocking.
Background #  I provide an implementation1 in code/exercise04/dmvm.c, in C, of double-precision matrix-vector multiplication, which computes"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Roofline analysis"><meta property="og:description" content="A roofline analysis of matrix-vector multiplication #  The goal of this exercise is to perform a roofline analysis of matrix-vector multiplication. We will look at the effect that compiler flags have on the performance of generated code. Next, we will see if the performance that we obtain is independent of the problem size. Finally, we will investigate loop blocking.
Background #  I provide an implementation1 in code/exercise04/dmvm.c, in C, of double-precision matrix-vector multiplication, which computes"><meta property="og:type" content="article"><meta property="og:url" content="https://teaching.wence.uk/comp52315/exercises/exercise04/"><meta property="article:modified_time" content="2022-04-07T18:18:31+01:00"><title>Roofline analysis | COMP52315 – Performance Engineering</title><link rel=icon href=/comp52315/favicon.svg type=image/x-icon><link rel=stylesheet href=/comp52315/book.min.0cb0b7d6a1ed5d0e95321cc15edca4d6e9cc406149d1f4a3f25fd532f6a3bb38.css integrity="sha256-DLC31qHtXQ6VMhzBXtyk1unMQGFJ0fSj8l/VMvajuzg="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true}]})});</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/comp52315/logo.svg alt=Logo><h2><a href=/comp52315>COMP52315 – Performance Engineering</a></h2></div><ul><li><span>Administrivia</span><ul><li><a href=/comp52315/setup/contact/>Contact details</a></li><li><a href=/comp52315/setup/hamilton/>Hamilton accounts</a></li><li><a href=/comp52315/setup/configuration/>ssh configuration</a></li><li><a href=/comp52315/setup/unix/>Unix resources</a></li></ul></li><li><span>Exercises</span><ul><li><a href=/comp52315/exercises/exercise01/>Sum reductions</a></li><li><a href=/comp52315/exercises/exercise02/>Caches</a></li><li><a href=/comp52315/exercises/exercise03/>Memory bandwidth</a></li><li><a href=/comp52315/exercises/exercise04/ class=active>Roofline analysis</a></li><li><a href=/comp52315/exercises/exercise05/>Models and measurements</a></li><li><a href=/comp52315/exercises/exercise06/>Profiling</a></li><li><a href=/comp52315/exercises/exercise07/>Loop tiling matrix transpose</a></li><li><a href=/comp52315/exercises/exercise08/>Loop tiling matrix-matrix multiplication</a></li><li><a href=/comp52315/exercises/exercise09/>Compiler feedback and the BLIS DGEMM</a></li><li><a href=/comp52315/exercises/exercise10/>Stencil layer conditions</a></li></ul></li><li><span>Notes</span><ul><li><a href=/comp52315/notes/introduction/>Introduction</a></li><li><a href=/comp52315/notes/memory/>The memory hierarchy</a></li><li><a href=/comp52315/notes/roofline/>Performance models: roofline</a></li><li><a href=/comp52315/notes/measurements/>Measurement and profiling</a></li><li><a href=/comp52315/notes/tiling/>Cache blocking/tiling</a></li></ul></li><li><a href=/comp52315/slides/>Slides</a></li><li><a href=/comp52315/coursework/>Coursework: fast finite elements</a><ul></ul></li><li><a href=/comp52315/resources/>Further resources</a></li><li><a href=/comp52315/acknowledgements/>Acknowledgements</a></li><li><span>Past editions</span><ul><li><a href=/comp52315/past-editions/2020-21/>2020/21</a><ul></ul></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/comp52315/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Roofline analysis</strong>
<label for=toc-control><img src=/comp52315/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#a-roofline-analysis-of-matrix-vector-multiplication>A roofline analysis of matrix-vector multiplication</a><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a></li><li><a href=#downloading-and-compiling-the-code>Downloading and compiling the code</a><ul><li><a href=#compilation-without-any-optimisation>Compilation without any optimisation</a></li></ul></li><li><a href=#obtain-the-machine-and-code-characteristics>Obtain the machine and code characteristics</a></li><li><a href=#produce-a-roofline-plot-of--o0-compiled-code>Produce a roofline plot of <code>-O0</code> compiled code</a></li><li><a href=#better-compiler-options>Better compiler options</a></li><li><a href=#loop-blocking-for-out-of-cache-performance>Loop blocking for out-of-cache performance</a></li></ul></li></ul></nav></aside></header><article class=markdown><blockquote class="book-hint warning"><span>This course page was updated until March 2022 when I left Durham University.
The materials herein are therefore not necessarily still in date.</span></blockquote><h1 id=a-roofline-analysis-of-matrix-vector-multiplication>A roofline analysis of matrix-vector multiplication
<a class=anchor href=#a-roofline-analysis-of-matrix-vector-multiplication>#</a></h1><p>The goal of this exercise is to perform a roofline analysis of
matrix-vector multiplication. We will look at the effect that compiler
flags have on the performance of generated code. Next, we will see if
the performance that we obtain is independent of the problem size.
Finally, we will investigate loop blocking.</p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>I provide <a href=https://teaching.wence.uk/comp52315/code/exercise04/dmvm.c>an implementation</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> in <code>code/exercise04/dmvm.c</code>, in C, of double-precision
matrix-vector multiplication, which computes</p><p>$$
\vec{y} = A \vec{x}
$$</p><p>for a \(n_\text{row} \times n_\text{col}\)
rectangular matrix. It takes two command-line arguments, the number of
rows and the number of columns. When run, it creates the matrices,
performs the computation and prints out information about the
performance. For example, after compiling and running with
<code>./dmvm 1000 2000</code> you might see output similar to
<code>1019 1000 2000 6491.23</code>. The four columns are:</p><ol><li>The number of iterations the test was run for;</li><li>The number of rows the matrix had;</li><li>The number of columns the matrix had;</li><li>The performance in MFLOPs/s.</li></ol><blockquote class="book-hint info"><span>Instead of downloading these code individually you should <a href=https://github.com/wenceorg/comp52315>clone the
repository</a> on Hamilton and work in the appropriate
<code>code/exerciseXX</code> subdirectory.</span></blockquote><h2 id=setup>Setup
<a class=anchor href=#setup>#</a></h2><p>As usual, you should do this on <a href=https://teaching.wence.uk/comp52315/exercises/exercise01/#setup-logging-in-to-hamilton>Hamilton</a>.</p><h2 id=downloading-and-compiling-the-code>Downloading and compiling the code
<a class=anchor href=#downloading-and-compiling-the-code>#</a></h2><p>We&rsquo;ll use the Intel C compiler for this exercise, which requires us to
load some extra modules. To get the most recent version, run <code>module load intel/2019.5</code> and <code>module load gcc/8.2.0</code>. In addition, we will want
to make performance measurements with likwid, so also <code>module load likwid/5.0.1</code>.</p><p>You can use <code>wget</code> to download the code when logged in.</p><blockquote class="book-hint warning"><span>Note: <code>wget</code> does not work on the compute nodes, so you should
download any material on the login (frontend) node.</span></blockquote><h3 id=compilation-without-any-optimisation>Compilation without any optimisation
<a class=anchor href=#compilation-without-any-optimisation>#</a></h3><p>First, we will compile without any optimisations.</p><blockquote class="book-hint warning"><span>Normally you should not do this, but we want to see what the effect
is!</span></blockquote><pre><code>icc -std=c11 -O0 -o dmvm dmvm.c
</code></pre><p>You should now be able to run the <code>dmvm</code> binary with <code>./dmvm 4000 4000</code> for a \(4000 \times 4000\) matrix.</p><h2 id=obtain-the-machine-and-code-characteristics>Obtain the machine and code characteristics
<a class=anchor href=#obtain-the-machine-and-code-characteristics>#</a></h2><p>To perform a roofline analysis, we need the machine and code
characteristics.</p><blockquote class=exercise><h3>Exercise</h3><span>Measure the main memory streaming memory bandwidth using
the <code>triad</code> benchmark
of <code>likwid-bench</code>.</span></blockquote><blockquote class=exercise><h3>Exercise</h3><span>Compute the peak floating point throughput of a compute node. A single
core on the Hamilton nodes runs at 2.9GHz and can issues two double
precision FMAs (fused multiply-add instructions) per cycle.</span></blockquote><blockquote class=exercise><h3>Exercise</h3><span>Read the code, in particular the <code>dmvm</code> function and
determine the best case arithmetic intensity by counting data accesses
(using the perfect cache model) and floating point operations.</span></blockquote><h2 id=produce-a-roofline-plot-of--o0-compiled-code>Produce a roofline plot of <code>-O0</code> compiled code
<a class=anchor href=#produce-a-roofline-plot-of--o0-compiled-code>#</a></h2><blockquote class=exercise><h3>Exercise</h3><span>Using a fixed number of columns \(n_\text{col} = 10000\), measure the performance of your <code>dmvm</code> binary over a range
of row sizes from 1000 to 100000. Plot the resulting data using a
roofline plot.</span></blockquote><blockquote class=question><h3>Question</h3><span>What do you think your next step in optimising the code
should be?</span></blockquote><h2 id=better-compiler-options>Better compiler options
<a class=anchor href=#better-compiler-options>#</a></h2><p>We&rsquo;ll stop crippling the compiler. Try these sets of compiler options:</p><ol><li><code>icc -std=c11 -O1 -o dmvm dmvm.c</code></li><li><code>icc -std=c11 -O2 -o dmvm dmvm.c</code></li><li><code>icc -std=c11 -O3 -o dmvm dmvm.c</code></li><li><code>icc -std=c11 -xCORE_AVX2 -unroll16 -mfma -O3 -o dmvm dmvm.c</code></li></ol><blockquote class=exercise><h3>Exercise</h3><span>Add the results you get from these runs to your roofline
plots. What do you see?</span></blockquote><blockquote class=question><h3>Question</h3><span>Is performance for any of these
options independent of the problem size? What do you think the
bottleneck for this algorithm is?</span></blockquote><h2 id=loop-blocking-for-out-of-cache-performance>Loop blocking for out-of-cache performance
<a class=anchor href=#loop-blocking-for-out-of-cache-performance>#</a></h2><p>You should have observed that when the number of rows gets too large,
the performance of the code drops by almost a factor of two. When the
number of rows is very large, some of the vector data (which is
accessed more than once) no longer fits in cache.</p><blockquote class=exercise><h3>Exercise</h3><span>Use the pessimal cache model to obtain a worst case arithmetic
intensity and add these new data points to your roofline plot.</span></blockquote><p>A mechanism to solve this problem is to traverse the data in an order
that is aware of the cache. For loop-based code, this is called <em>loop
blocking</em> or <em>tiling</em>. I provide an implementation of <a href=https://teaching.wence.uk/comp52315/code/exercise04/dmvm-blocked.c>a simple
scheme</a> in
<code>code/exercise04/dmvm-blocked.c</code>. Compile it, using the set of
compiler options that worked best for the original code. Use <code>-o dmvm-blocked</code> to produce a new binary.</p><blockquote class=exercise><h3>Exercise</h3><span>As before, using a fixed number of columns \(n_\text{col} =
10000\), measure the performance of your
<code>dmvm-blocked</code> binary over a range of row sizes from 1000
to 100000. You should observe that the performance is now largely
insensitive to the number of rows. Plot the resulting data using a
roofline plot.</span></blockquote><blockquote class=question><h3>Question</h3><span>What do you think your next step (if any) in optimising
the code should be?</span></blockquote><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>This code is taken from
<a href=https://github.com/RRZE-HPC/Code-teaching>examples</a> developed
at <a href=https://www.rrze.fau.de/>RRZE</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/wenceorg/comp52315/commit/cdfbd8f86c56d4a17e7e322b59a75940cea4fb4e title="Last modified by Lawrence Mitchell | April 7, 2022" target=_blank rel=noopener><img src=/comp52315/svg/calendar.svg class=book-icon alt=Calendar>
<span>April 7, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/wenceorg/comp52315/edit/main/site/content//exercises/exercise04.md target=_blank rel=noopener><img src=/comp52315/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash; <a href=mailto:lawrence.mitchell@durham.ac.uk>Lawrence Mitchell</a> and <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/comp52315/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#a-roofline-analysis-of-matrix-vector-multiplication>A roofline analysis of matrix-vector multiplication</a><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a></li><li><a href=#downloading-and-compiling-the-code>Downloading and compiling the code</a><ul><li><a href=#compilation-without-any-optimisation>Compilation without any optimisation</a></li></ul></li><li><a href=#obtain-the-machine-and-code-characteristics>Obtain the machine and code characteristics</a></li><li><a href=#produce-a-roofline-plot-of--o0-compiled-code>Produce a roofline plot of <code>-O0</code> compiled code</a></li><li><a href=#better-compiler-options>Better compiler options</a></li><li><a href=#loop-blocking-for-out-of-cache-performance>Loop blocking for out-of-cache performance</a></li></ul></li></ul></nav></aside></main></body></html>