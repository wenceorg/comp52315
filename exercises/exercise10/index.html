<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Loop tiling for stencil codes #  We&rsquo;re going to investigate the layer condition loop tiling guidance for stencil codes. We&rsquo;ll use as an exemplar the five-point finite difference stencil for the Laplacian on a regular grid in code/exercise10/fivepoint.c.
The layer condition model was developed by a group at Erlangen, and they provide an interactive calculator.
As usual, we&rsquo;re going to use the Intel compiler on Hamilton, so after logging in and downloading the code, load the relevant modules"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Stencil layer conditions"><meta property="og:description" content="Loop tiling for stencil codes #  We&rsquo;re going to investigate the layer condition loop tiling guidance for stencil codes. We&rsquo;ll use as an exemplar the five-point finite difference stencil for the Laplacian on a regular grid in code/exercise10/fivepoint.c.
The layer condition model was developed by a group at Erlangen, and they provide an interactive calculator.
As usual, we&rsquo;re going to use the Intel compiler on Hamilton, so after logging in and downloading the code, load the relevant modules"><meta property="og:type" content="article"><meta property="og:url" content="https://teaching.wence.uk/comp52315/exercises/exercise10/"><meta property="article:modified_time" content="2022-04-07T18:18:31+01:00"><title>Stencil layer conditions | COMP52315 – Performance Engineering</title><link rel=icon href=/comp52315/favicon.svg type=image/x-icon><link rel=stylesheet href=/comp52315/book.min.0cb0b7d6a1ed5d0e95321cc15edca4d6e9cc406149d1f4a3f25fd532f6a3bb38.css integrity="sha256-DLC31qHtXQ6VMhzBXtyk1unMQGFJ0fSj8l/VMvajuzg="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true}]})});</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/comp52315/logo.svg alt=Logo><h2><a href=/comp52315>COMP52315 – Performance Engineering</a></h2></div><ul><li><span>Administrivia</span><ul><li><a href=/comp52315/setup/contact/>Contact details</a></li><li><a href=/comp52315/setup/hamilton/>Hamilton accounts</a></li><li><a href=/comp52315/setup/configuration/>ssh configuration</a></li><li><a href=/comp52315/setup/unix/>Unix resources</a></li></ul></li><li><span>Exercises</span><ul><li><a href=/comp52315/exercises/exercise01/>Sum reductions</a></li><li><a href=/comp52315/exercises/exercise02/>Caches</a></li><li><a href=/comp52315/exercises/exercise03/>Memory bandwidth</a></li><li><a href=/comp52315/exercises/exercise04/>Roofline analysis</a></li><li><a href=/comp52315/exercises/exercise05/>Models and measurements</a></li><li><a href=/comp52315/exercises/exercise06/>Profiling</a></li><li><a href=/comp52315/exercises/exercise07/>Loop tiling matrix transpose</a></li><li><a href=/comp52315/exercises/exercise08/>Loop tiling matrix-matrix multiplication</a></li><li><a href=/comp52315/exercises/exercise09/>Compiler feedback and the BLIS DGEMM</a></li><li><a href=/comp52315/exercises/exercise10/ class=active>Stencil layer conditions</a></li></ul></li><li><span>Notes</span><ul><li><a href=/comp52315/notes/introduction/>Introduction</a></li><li><a href=/comp52315/notes/memory/>The memory hierarchy</a></li><li><a href=/comp52315/notes/roofline/>Performance models: roofline</a></li><li><a href=/comp52315/notes/measurements/>Measurement and profiling</a></li><li><a href=/comp52315/notes/tiling/>Cache blocking/tiling</a></li></ul></li><li><a href=/comp52315/slides/>Slides</a></li><li><a href=/comp52315/coursework/>Coursework: fast finite elements</a><ul></ul></li><li><a href=/comp52315/resources/>Further resources</a></li><li><a href=/comp52315/acknowledgements/>Acknowledgements</a></li><li><span>Past editions</span><ul><li><a href=/comp52315/past-editions/2020-21/>2020/21</a><ul></ul></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/comp52315/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Stencil layer conditions</strong>
<label for=toc-control><img src=/comp52315/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#loop-tiling-for-stencil-codes>Loop tiling for stencil codes</a><ul><li><a href=#throughput-of-untiled-loops>Throughput of untiled loops</a></li><li><a href=#throughput-of-tiled-loops>Throughput of tiled loops</a></li><li><a href=#validation-of-the-data-movement-model>Validation of the data movement model</a></li><li><a href=#vectorisation>Vectorisation</a></li></ul></li></ul></nav></aside></header><article class=markdown><blockquote class="book-hint warning"><span>This course page was updated until March 2022 when I left Durham University.
The materials herein are therefore not necessarily still in date.</span></blockquote><h1 id=loop-tiling-for-stencil-codes>Loop tiling for stencil codes
<a class=anchor href=#loop-tiling-for-stencil-codes>#</a></h1><p>We&rsquo;re going to investigate the <em>layer condition</em> loop tiling
guidance for stencil codes. We&rsquo;ll use as an exemplar the five-point
finite difference stencil for the Laplacian on a <a href=https://teaching.wence.uk/comp52315/code/exercise10/fivepoint.c>regular grid</a> in <code>code/exercise10/fivepoint.c</code>.</p><p>The layer condition model was developed by a group at Erlangen, and
they provide an <a href=https://rrze-hpc.github.io/layer-condition/>interactive
calculator</a>.</p><p>As usual, we&rsquo;re going to use the Intel compiler on Hamilton, so after
logging in and downloading the code, load the relevant modules</p><pre><code>module load gcc/8.2.0
module load intel/2019.5
</code></pre><p>The code can be compiled with <code>icc -xBROADWELL -O3 -o fivepoint fivepoint.c</code>.</p><h2 id=throughput-of-untiled-loops>Throughput of untiled loops
<a class=anchor href=#throughput-of-untiled-loops>#</a></h2><p>The code runs and reports performance in MLUP/s (millions of lattice
updates per second). You can control both the number of rows of the
grid (the innermost loop) and the number of columns.</p><p>For fewer than 10,000 rows, set the number of columns equal to the
number of rows. For more than 10,000 rows, keep the product of rows
and columns approximately constant at \(10^9\).</p><blockquote class=question><h3>Question</h3><span>What happens to the performance when you vary the number of rows from
1000 up to 100,000,000?</span></blockquote><blockquote class=exercise><h3>Exercise</h3><span>Produce a plot of MLUP/s against row size.</span></blockquote><blockquote class=question><h3>Question</h3><span>Do you observe any tell-tale drops in performance?</span></blockquote><h2 id=throughput-of-tiled-loops>Throughput of tiled loops
<a class=anchor href=#throughput-of-tiled-loops>#</a></h2><blockquote class=exercise><h3>Exercise</h3><span>Repeat the above study, this time with the tiled version. Try
calculating appropriate blocking sizes for both L2 and L3 caches using
the layer condition we discussed in lectures. Add the performance you
achieve with the two different blocking factors to your plot of the
untiled code.</span></blockquote><blockquote class=question><h3>Question</h3><span>What do you observe?</span></blockquote><h2 id=validation-of-the-data-movement-model>Validation of the data movement model
<a class=anchor href=#validation-of-the-data-movement-model>#</a></h2><p>Load the <code>likwid/5.0.1</code> module, and recompile the code with
likwid-perfctr support. <code>icc -xBROADWELL -O3 -DLIKWID_PERFMON -o fivepoint fivepoint.c -llikwid</code>. The update loop is instrumented with
likwid markers. Measure the <code>MEM_DP</code> group.</p><blockquote class=question><h3>Question</h3><span><p>What is the measured number of bytes of data required per LUP?</p><p>Does it match your expectations?</p></span></blockquote><h2 id=vectorisation>Vectorisation
<a class=anchor href=#vectorisation>#</a></h2><p>Look again at the performance counters. Did the compiler manage to
vectorise this code at all? Ask the intel compiler for an optimisation
report to see if you can work out why it was, or was not, vectorised.
If no vectorisation was enabled, see if you can convince the compiler
to vectorise through judicious use of <code>#pragma omp simd</code> annotations.</p><blockquote class=question><h3>Question</h3><span>Does managing to enable vectorisation change any of the results of
the previous sections at all?</span></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/wenceorg/comp52315/commit/cdfbd8f86c56d4a17e7e322b59a75940cea4fb4e title="Last modified by Lawrence Mitchell | April 7, 2022" target=_blank rel=noopener><img src=/comp52315/svg/calendar.svg class=book-icon alt=Calendar>
<span>April 7, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/wenceorg/comp52315/edit/main/site/content//exercises/exercise10.md target=_blank rel=noopener><img src=/comp52315/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash; <a href=mailto:lawrence.mitchell@durham.ac.uk>Lawrence Mitchell</a> and <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/comp52315/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#loop-tiling-for-stencil-codes>Loop tiling for stencil codes</a><ul><li><a href=#throughput-of-untiled-loops>Throughput of untiled loops</a></li><li><a href=#throughput-of-tiled-loops>Throughput of tiled loops</a></li><li><a href=#validation-of-the-data-movement-model>Validation of the data movement model</a></li><li><a href=#vectorisation>Vectorisation</a></li></ul></li></ul></nav></aside></main></body></html>